<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (head is unchanged) ... -->
</head>
<body>
    <!-- No more loading screen needed, the app loads instantly -->
    <div id="app-content">
        <!-- ... (all app content is unchanged) ... -->
    </div>

    <!-- ... (Database Modal is unchanged) ... -->

    <script>
        // ... (all variable declarations are the same) ...

        async function fetchData() {
            rsiLoader.style.display = 'inline-block';
            alertLoader.style.display = 'inline-block';

            try {
                const response = await fetch('/data');
                const data = await response.json();

                // No more status check needed
                
                let rsiHtml = '';
                data.market_data.forEach((item, index) => {
                    // --- NEW: Handle null RSI gracefully ---
                    const rsiValue = item.rsi;
                    const rsiText = rsiValue !== null ? rsiValue.toFixed(2) : '...';
                    const rsiClass = rsiValue > 70 ? 'rsi-high' : '';

                    const changeClass = item.change_24h >= 0 ? 'positive' : 'negative';
                    let priceText = '...';
                    let changeText = '...';
                    
                    // Only show price/change if RSI is calculated
                    if (rsiValue !== null && rsiValue >= 65) {
                        priceText = item.price ? `$${item.price.toFixed(4)}` : '...';
                        changeText = item.change_24h ? `<span class="${changeClass}">${item.change_24h.toFixed(2)}%</span>` : '...';
                    }

                    const chartButton = `<td><a href="https://www.binance.com/en/futures/${item.symbol}" target="_blank" rel="noopener noreferrer" class="chart-btn">Chart &gt;</a></td>`;
                    rsiHtml += `<tr><td>${index + 1}</td><td>${item.symbol}</td><td class="${rsiClass}">${rsiText}</td><td>${priceText}</td><td>${changeText}</td>${chartButton}</tr>`;
                } );
                rsiTableBody.innerHTML = rsiHtml;

                // ... (rest of the function is the same) ...
                const rsiSortKey = Object.keys(sortStates).find(k => k.startsWith('rsi-table'));
                if (rsiSortKey) {
                    const colIndex = rsiSortKey.split('-')[1];
                    delete sortStates[rsiSortKey];
                    sortTable('rsi-table', colIndex);
                }
                let alertHtml = '';
                data.alert_log.forEach(alert => {
                    const liveRsiClass = alert.live_rsi > 70 ? 'rsi-high' : '';
                    alertHtml += `<tr><td class="alert-num">#${alert.alert_num}</td><td>${alert.time}</td><td>${alert.symbol}</td><td>${alert.sent_rsi.toFixed(2)}</td><td class="${liveRsiClass}">${typeof alert.live_rsi === 'number' ? alert.live_rsi.toFixed(2) : 'N/A'}</td></tr>`;
                });
                alertLogTableBody.innerHTML = alertHtml;
                rsiOver80Count.textContent = data.rsi_over_80_count;
                totalSymbolsCount.textContent = data.total_symbols;

            } catch (error) {
                console.error("Fetch error:", error);
            } finally {
                rsiLoader.style.display = 'none';
                alertLoader.style.display = 'none';
            }
        }

        // ... (The rest of the script is unchanged) ...
        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>
