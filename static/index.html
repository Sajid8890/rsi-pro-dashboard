<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (head is unchanged) ... -->
    <title>RSI Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (all styles are unchanged ) ... */
    </style>
</head>
<body>

    <!-- UPDATED: Loading screen now has a text element -->
    <div id="loading-screen" class="loading-screen">
        <div>
            <div class="spinner"></div>
            <div id="loading-text" style="color: white; margin-top: 1rem; text-align: center;">Initializing...</div>
        </div>
    </div>

    <div id="app-content" style="display: none;" class="fade-in">
        <!-- ... (all app content is unchanged) ... -->
    </div>

    <!-- ... (Database Modal is unchanged) ... -->

    <script>
        // ... (all variable declarations are the same) ...
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        const appContent = document.getElementById('app-content');
        // ... (rest of the variables)

        // --- UPDATED: The fetchData function is now much smarter ---
        async function fetchData() {
            // Don't show the small loaders unless the app is ready
            if (appContent.style.display === 'block') {
                rsiLoader.style.display = 'inline-block';
                alertLoader.style.display = 'inline-block';
            }

            try {
                const response = await fetch('/data');
                const data = await response.json();

                // --- THE NEW LOGIC IS HERE ---
                if (data.status === 'initializing') {
                    // If the backend is not ready, update the loading screen text
                    loadingText.textContent = `Warming up... (${data.init_progress}%)`;
                    return; // Stop here and wait for the next fetch
                } 
                
                // If we get here, it means status is "ready"
                if (loadingScreen.style.display !== 'none') {
                    loadingScreen.style.display = 'none';
                    appContent.style.display = 'block';
                }

                // --- (The rest of the function that builds the tables is UNCHANGED) ---
                let rsiHtml = '';
                data.market_data.forEach((item, index) => {
                    const rsiClass = item.rsi > 70 ? 'rsi-high' : '';
                    const changeClass = item.change_24h >= 0 ? 'positive' : 'negative';
                    let priceText = '...';
                    let changeText = '...';
                    if (item.rsi >= 65) {
                        priceText = item.price ? `$${item.price.toFixed(4)}` : '...';
                        changeText = item.change_24h ? `<span class="${changeClass}">${item.change_24h.toFixed(2)}%</span>` : '...';
                    }
                    const chartButton = `<td><a href="https://www.binance.com/en/futures/${item.symbol}" target="_blank" rel="noopener noreferrer" class="chart-btn">Chart &gt;</a></td>`;
                    rsiHtml += `<tr><td>${index + 1}</td><td>${item.symbol}</td><td class="${rsiClass}">${item.rsi.toFixed(2 )}</td><td>${priceText}</td><td>${changeText}</td>${chartButton}</tr>`;
                });
                rsiTableBody.innerHTML = rsiHtml;
                const rsiSortKey = Object.keys(sortStates).find(k => k.startsWith('rsi-table'));
                if (rsiSortKey) {
                    const colIndex = rsiSortKey.split('-')[1];
                    delete sortStates[rsiSortKey];
                    sortTable('rsi-table', colIndex);
                }
                let alertHtml = '';
                data.alert_log.forEach(alert => {
                    const liveRsiClass = alert.live_rsi > 70 ? 'rsi-high' : '';
                    alertHtml += `<tr><td class="alert-num">#${alert.alert_num}</td><td>${alert.time}</td><td>${alert.symbol}</td><td>${alert.sent_rsi.toFixed(2)}</td><td class="${liveRsiClass}">${typeof alert.live_rsi === 'number' ? alert.live_rsi.toFixed(2) : 'N/A'}</td></tr>`;
                });
                alertLogTableBody.innerHTML = alertHtml;
                rsiOver80Count.textContent = data.rsi_over_80_count;
                totalSymbolsCount.textContent = data.total_symbols;

            } catch (error) {
                console.error("Fetch error:", error);
                loadingText.textContent = "Error connecting to server. Retrying...";
            } finally {
                rsiLoader.style.display = 'none';
                alertLoader.style.display = 'none';
            }
        }

        // ... (The rest of the script is unchanged) ...
        // Start the main data fetch loop
        setInterval(fetchData, 2000); // Check status every 2 seconds
        fetchData(); // Initial call
    </script>
</body>
</html>
